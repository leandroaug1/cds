<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    :root { --bi-blue: #004a99; --bi-gray: #f3f2f1; --bi-green: #00ce64; --bi-yellow: #f2c811; --bi-red: #e81123; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bi-gray); margin: 0; padding-bottom: 30px; }
    .header { background: var(--bi-blue); color: white; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; }
    .filter-bar { background: white; padding: 15px 25px; display: flex; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); align-items: flex-end; }
    .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 15px; }
    .kpi-card { background: white; padding: 15px; border-radius: 4px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-top: 5px solid var(--bi-blue); }
    .kpi-value { font-size: 26px; font-weight: bold; margin-top: 5px; }
    .visuals-container { display: flex; gap: 12px; padding: 0 15px; height: 380px; margin-bottom: 15px; }
    .chart-box { background: white; flex: 1; border-radius: 4px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .table-container { background: white; margin: 0 15px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th { background: #faf9f8; padding: 10px; text-align: left; border-bottom: 2px solid #eee; }
    td { padding: 8px 10px; border-bottom: 1px solid #f1f3f4; }
    #loader { position: fixed; width: 100%; height: 100%; background: white; z-index: 999; display: flex; justify-content: center; align-items: center; }
  </style>
</head>
<body>

<div id="loader"><h3>Sincronizando...</h3></div>

<div class="header">
  <h3 style="margin:0">SAP Quality Analytics</h3>
  <button onclick="iniciar()" style="background:var(--bi-yellow); border:none; padding:8px 15px; cursor:pointer; font-weight:bold; border-radius:4px">Atualizar</button>
</div>

<div class="filter-bar">
  <div style="display:flex; flex-direction:column; font-size:11px;">
    <label>BUSCA GLOBAL</label>
    <input type="text" id="f-busca" placeholder="CD, OS, PN..." onkeyup="renderizar()" style="padding:6px; width:300px; border:1px solid #ddd; border-radius:4px;">
  </div>
  <button onclick="limparFiltros()" style="padding:7px 15px; cursor:pointer; background:#eee; border:1px solid #ccc; border-radius:4px; font-weight:bold;">Limpar Filtros</button>
</div>

<div class="kpi-row">
  <div class="kpi-card">VOL. TOTAL<div id="k-total" class="kpi-value">-</div></div>
  <div class="kpi-card" style="border-top-color:var(--bi-red)">QTD ESCAPE<div id="k-escape" class="kpi-value" style="color:var(--bi-red)">-</div></div>
  <div class="kpi-card" style="border-top-color:var(--bi-green)">PROCEDENTES<div id="k-proc" class="kpi-value" style="color:var(--bi-green)">-</div></div>
  <div class="kpi-card" style="border-top-color:var(--bi-yellow)">NÃO PROC.<div id="k-nproc" class="kpi-value" style="color:var(--bi-yellow)">-</div></div>
</div>

<div class="visuals-container">
  <div class="chart-box" id="div_rosca"></div>
  <div class="chart-box" id="div_barras"></div>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr><th>CD</th><th>OS</th><th>PN</th><th>APLICAÇÃO</th><th>DATA</th><th>QTD</th><th>PARECER</th></tr>
    </thead>
    <tbody id="corpoTabela"></tbody>
  </table>
</div>

<script>
  var dadosOriginais = [];
  var filtroClique = null; // Filtro persistente do gráfico

  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(iniciar);

  function iniciar() {
    document.getElementById('loader').style.display = 'flex';
    google.script.run.withSuccessHandler(function(res) {
      dadosOriginais = res;
      document.getElementById('loader').style.display = 'none';
      renderizar();
    }).getDadosDashboard();
  }

  function limparFiltros() {
    filtroClique = null;
    document.getElementById('f-busca').value = "";
    renderizar();
  }

  function renderizar() {
    const busca = document.getElementById('f-busca').value.toLowerCase();
    
    // FILTRAGEM UNIFICADA
    let filtrados = dadosOriginais.filter(d => {
      const matchBusca = !busca || (d.cd + d.os + d.pn + d.aplic).toLowerCase().includes(busca);
      const matchClique = !filtroClique || d.parecer.toLowerCase() === filtroClique.toLowerCase();
      return matchBusca && matchClique;
    });

    // ATUALIZAR KPIs (AGORA FILTRAM!)
    document.getElementById('k-total').innerText = filtrados.length;
    document.getElementById('k-escape').innerText = filtrados.reduce((a, b) => a + b.qtd, 0);
    document.getElementById('k-proc').innerText = filtrados.filter(d => d.parecer.toLowerCase() === "procedente").length;
    document.getElementById('k-nproc').innerText = filtrados.filter(d => d.parecer.toLowerCase().includes("não")).length;

    // ATUALIZAR TABELA
    document.getElementById('corpoTabela').innerHTML = filtrados.map(d => `
      <tr><td>${d.cd}</td><td>${d.os}</td><td>${d.pn}</td><td>${d.aplic}</td>
      <td>${d.dataParaExibir}</td><td><b>${d.qtd}</b></td><td>${d.parecer}</td></tr>
    `).join('');

    desenharGraficos(filtrados);
  }

  function desenharGraficos(dadosFiltrados) {
    // 1. Gráfico de Rosca (Sempre com dados totais para permitir seleção)
    const p = dadosOriginais.filter(d => d.parecer.toLowerCase() === "procedente").length;
    const np = dadosOriginais.filter(d => d.parecer.toLowerCase().includes("não")).length;
    const dataR = google.visualization.arrayToDataTable([['S', 'Q'], ['Procedente', p], ['Não Procedente', np]]);
    
    const chartR = new google.visualization.PieChart(document.getElementById('div_rosca'));

    // EVENTO DE CLIQUE ESTILO POWER BI
    google.visualization.events.addListener(chartR, 'select', function() {
      const sel = chartR.getSelection()[0];
      filtroClique = sel ? dataR.getValue(sel.row, 0) : null;
      renderizar(); // DISPARA FILTRO EM TUDO
    });

    chartR.draw(dataR, { pieHole: 0.5, title: 'Filtro por Parecer (Clique)', colors: ['#00ce64', '#f2c811'], legend:'bottom' });

    // 2. Gráfico de Barras (Contextualizado)
    const apps = {};
    dadosFiltrados.forEach(d => { apps[d.aplic] = (apps[d.aplic] || 0) + 1; });
    const dataB = new google.visualization.DataTable();
    dataB.addColumn('string', 'App'); dataB.addColumn('number', 'Qtd');
    Object.keys(apps).sort((a,b)=>apps[b]-apps[a]).slice(0,10).forEach(k => dataB.addRow([k, apps[k]]));

    new google.visualization.BarChart(document.getElementById('div_barras')).draw(dataB, {
      title: 'Top 10 Aplicações (Filtrado)', colors: ['#004a99'], legend: 'none', chartArea:{width:'60%', height:'80%'}
    });
  }
</script>
</body>
</html>
