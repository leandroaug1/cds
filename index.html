<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: 'Roboto', sans-serif; background-color: #f4f6f8; margin: 0; }
    #loading { position: fixed; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    .header { background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px; }
    .card { background: white; padding: 20px; border-radius: 6px; border-left: 5px solid #3498db; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .charts-row { display: flex; gap: 20px; padding: 0 20px; height: 450px; }
    .chart-box { background: white; border-radius: 6px; padding: 15px; flex: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    table { width: 97%; margin: 20px auto; border-collapse: collapse; background: white; font-size: 12px; }
    th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #eee; }
    td { padding: 10px; border-bottom: 1px solid #f1f3f4; }
  </style>
</head>
<body>

  <div id="loading"><h3>Sincronizando com Banco de Dados...</h3></div>

  <div class="header">
    <h1>SAP Quality Dashboard</h1>
    <button onclick="iniciar()" style="background:#f1c40f; border:none; padding:10px 20px; cursor:pointer; font-weight:bold; border-radius:4px">Atualizar Dados</button>
  </div>

  <div class="kpi-grid">
    <div class="card">TOTAL CDS<div id="kpi-total" style="font-size:28px; font-weight:bold; color:#3498db">-</div></div>
    <div class="card" style="border-color:#e74c3c">ESCAPE<div id="kpi-escape" style="font-size:28px; font-weight:bold; color:#e74c3c">-</div></div>
    <div class="card" style="border-color:#2ecc71">PROCEDENTES<div id="kpi-proc" style="font-size:28px; font-weight:bold; color:#2ecc71">-</div></div>
    <div class="card" style="border-color:#f1c40f">NÃO PROC.<div id="kpi-nproc" style="font-size:28px; font-weight:bold; color:#f1c40f">-</div></div>
  </div>

  <div class="charts-row">
    <div class="chart-box" id="div_rosca"></div>
    <div class="chart-box" id="div_barras"></div>
  </div>

  <table>
    <thead><tr><th>CD</th><th>OS</th><th>PN</th><th>Aplic</th><th>Data</th><th>Qtd</th><th>Parecer</th><th>Anexos</th></tr></thead>
    <tbody id="corpoTabela"></tbody>
  </table>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwOzk7XSX91ogz8mvf8N42avCQtTykJF56BfvtSHGXK149u7KiiYMopnHrg80FGenk5Pw/exec";
    var dadosBrutos = [];

    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(iniciar);

    async function apiCall(action, data = null) {
      const resp = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: action, data: data }) });
      return await resp.json();
    }

    function iniciar() {
      document.getElementById('loading').style.display = 'flex';
      apiCall('getDados').then(dados => {
        dadosBrutos = dados;
        document.getElementById('loading').style.display = 'none';
        renderizar();
      });
    }

    function renderizar() {
      // KPIs
      document.getElementById('kpi-total').innerText = dadosBrutos.length;
      document.getElementById('kpi-escape').innerText = dadosBrutos.reduce((a, b) => a + b.qtd, 0);
      document.getElementById('kpi-proc').innerText = dadosBrutos.filter(d => d.parecer === "Procedente").length;
      document.getElementById('kpi-nproc').innerText = dadosBrutos.filter(d => d.parecer.includes("Não")).length;

      // Tabela CORRIGIDA para ler a chave dataVisual
      const html = dadosBrutos.map(d => `
        <tr>
          <td>${d.cd}</td><td>${d.os}</td><td>${d.pn}</td><td>${d.aplic}</td>
          <td>${d.dataVisual}</td> <td><b>${d.qtd}</b></td><td>${d.parecer}</td><td>${d.anexosHtml}</td>
        </tr>
      `).join('');
      document.getElementById('corpoTabela').innerHTML = html;

      desenharGraficos();
    }

    function desenharGraficos() {
      // Gráfico de Parecer Técnico (Rosca)
      var proc = dadosBrutos.filter(d => d.parecer === "Procedente").length;
      var nProc = dadosBrutos.filter(d => d.parecer.includes("Não")).length;
      
      var dataRosca = google.visualization.arrayToDataTable([
        ['Status', 'Quantidade'], 
        ['Procedente', proc], 
        ['Não Procedente', nProc]
      ]);
      
      new google.visualization.PieChart(document.getElementById('div_rosca')).draw(dataRosca, {
        pieHole: 0.6, 
        title: 'Parecer Técnico', 
        colors: ['#00ce64', '#f1c40f'], // Verde e Amarelo
        chartArea: {width:'90%', height:'75%'}, 
        legend: {position: 'bottom'}
      });

      // Gráfico de Top Ocorrências (Barras)
      var apps = {};
      dadosBrutos.forEach(d => { apps[d.aplic] = (apps[d.aplic] || 0) + 1; });
      var barData = new google.visualization.DataTable();
      barData.addColumn('string', 'App'); 
      barData.addColumn('number', 'Qtd'); 
      barData.addColumn({type:'string', role:'annotation'});
      
      Object.keys(apps).sort((a,b)=>apps[b]-apps[a]).slice(0,10).forEach(k => {
        barData.addRow([k, apps[k], apps[k].toString()]);
      });
      
      new google.visualization.ColumnChart(document.getElementById('div_barras')).draw(barData, {
        title: 'Top 10 Aplicações', 
        colors: ['#2c3e50'], // Azul Escuro
        legend: 'none', 
        chartArea: {width:'85%', height:'70%'}
      });
    }
  </script>
</body>
</html>
