<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    /* Estilos originais preservados para manter o visual do Dashboard */
    body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background-color: #f4f6f8; color: #333; }
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:#2c3e50; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .header { background-color: #2c3e50; color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .header h1 { margin: 0; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .btn-yellow { background-color: #f1c40f; color: #2c3e50; padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; border:none; }
    .main-content { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .card { background: white; padding: 20px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 5px solid #3498db; }
    .charts-row { display: flex; gap: 20px; height: 400px; margin-bottom: 20px; }
    .chart-box { background: white; border-radius: 6px; padding: 15px; flex: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; font-size: 12px; background: white; }
    th { background-color: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0; }
    td { padding: 10px; border-bottom: 1px solid #f1f3f4; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 25px; border-radius: 8px; width: 500px; max-height: 90vh; overflow-y: auto; }
  </style>
</head>
<body>

  <div id="loading"><div class="spinner"></div><div>Sincronizando com Banco de Dados...</div></div>

  <div class="header">
    <h1><span class="material-icons">analytics</span> SAP Quality Dashboard</h1>
    <button class="btn-yellow" onclick="abrirNovoRegistro()">Novo Registro</button>
  </div>

  <div class="main-content">
    <div class="kpi-grid">
      <div class="card"><div>TOTAL CDS</div><div id="kpi-total" style="font-size:32px; font-weight:bold; color:#3498db">-</div></div>
      <div class="card" style="border-left-color:#e74c3c"><div>ESCAPE</div><div id="kpi-escape" style="font-size:32px; font-weight:bold; color:#e74c3c">-</div></div>
      <div class="card" style="border-left-color:#2ecc71"><div>PROCEDENTES</div><div id="kpi-procedentes" style="font-size:32px; font-weight:bold; color:#2ecc71">-</div></div>
      <div class="card" style="border-left-color:#f1c40f"><div>NÃO PROC.</div><div id="kpi-nao-procedentes" style="font-size:32px; font-weight:bold; color:#f1c40f">-</div></div>
    </div>

    <div class="charts-row">
      <div class="chart-box" id="div_rosca"></div>
      <div class="chart-box" id="div_barras"></div>
    </div>

    <div class="table-section" style="background:white; padding:15px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1)">
      <table id="minhaTabela">
        <thead>
          <tr><th>CD</th><th>OS</th><th>PN</th><th>Aplic</th><th>Data</th><th>Qtd</th><th>Parecer</th><th>Anexos</th><th>Ação</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="modal-overlay" id="modalFormulario">
    <div class="modal-content">
      <h2 id="tituloModal">Registro</h2>
      <form id="formRegistro">
        <input type="hidden" id="inputIdLinha">
        <div style="margin-bottom:10px"><label>CD</label><input type="text" id="inputCd" style="width:100%; padding:8px" required></div>
        <div style="margin-bottom:10px"><label>Qtd</label><input type="number" id="inputQtd" style="width:100%; padding:8px" required></div>
        <div style="margin-bottom:10px"><label>Aplicação</label><input type="text" id="inputAplic" style="width:100%; padding:8px" required></div>
        <div style="margin-bottom:10px"><label>Data</label><input type="date" id="inputData" style="width:100%; padding:8px" required></div>
        <div style="margin-bottom:15px">
          <label>Parecer</label>
          <select id="inputParecer" style="width:100%; padding:8px">
            <option value="Procedente">Procedente</option>
            <option value="Não Procedente">Não Procedente</option>
          </select>
        </div>
        <button type="button" onclick="prepararEnvio()" style="width:100%; padding:10px; background:#2ecc71; color:white; border:none; cursor:pointer">SALVAR</button>
        <button type="button" onclick="fecharModal()" style="width:100%; padding:10px; background:#95a5a6; color:white; border:none; margin-top:5px; cursor:pointer">CANCELAR</button>
      </form>
    </div>
  </div>

  <script>
    // URL DA SUA API FORNECIDA
    const API_URL = "https://script.google.com/macros/s/AKfycbwOzk7XSX91ogz8mvf8N42avCQtTykJF56BfvtSHGXK149u7KiiYMopnHrg80FGenk5Pw/exec";
    var dadosBrutos = [];

    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(iniciarSistema);

    // Função de comunicação via Fetch (substitui google.script.run)
    async function apiCall(action, data = null) {
      const response = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: action, data: data })
      });
      return await response.json();
    }

    function iniciarSistema() {
      apiCall('getDados')
        .then(dados => {
          dadosBrutos = dados;
          document.getElementById('loading').style.display = 'none';
          renderizarDashboard();
        })
        .catch(err => {
          console.error(err);
          document.getElementById('loading').innerHTML = "Falha ao conectar com o banco de dados.";
        });
    }

    function renderizarDashboard() {
      // Atualiza KPIs
      document.getElementById('kpi-total').innerText = dadosBrutos.length;
      document.getElementById('kpi-escape').innerText = dadosBrutos.reduce((acc, i) => acc + i.qtd, 0);
      document.getElementById('kpi-procedentes').innerText = dadosBrutos.filter(i => i.parecer === "Procedente").length;
      document.getElementById('kpi-nao-procedentes').innerText = dadosBrutos.filter(i => i.parecer.includes("Não Procedente")).length;

      // Atualiza Tabela
      const tbody = document.querySelector('#minhaTabela tbody');
      tbody.innerHTML = dadosBrutos.slice(0, 50).map(d => `
        <tr>
          <td>${d.cd}</td><td>${d.os}</td><td>${d.pn}</td><td>${d.aplic}</td>
          <td>${d.dataVisual}</td><td>${d.qtd}</td><td>${d.parecer}</td><td>${d.anexosHtml}</td>
          <td><span class="material-icons" style="cursor:pointer; color:#f39c12" onclick="editarRegistro(${d.idLinha})">edit</span></td>
        </tr>
      `).join('');

      desenharGraficos();
    }

    function desenharGraficos() {
      // Gráfico de Rosca
      var proc = dadosBrutos.filter(i => i.parecer === "Procedente").length;
      var nProc = dadosBrutos.filter(i => i.parecer.includes("Não Procedente")).length;
      
      var dataRosca = google.visualization.arrayToDataTable([
        ['Status', 'Qtd'], ['Procedente', proc], ['Não Procedente', nProc]
      ]);
      new google.visualization.PieChart(document.getElementById('div_rosca')).draw(dataRosca, {pieHole: 0.4, title: 'Parecer Técnico'});

      // Gráfico de Barras
      var apps = {};
      dadosBrutos.forEach(d => { apps[d.aplic] = (apps[d.aplic] || 0) + 1; });
      var dataBarra = [['Aplicação', 'Qtd']];
      Object.keys(apps).slice(0,10).forEach(k => dataBarra.push([k, apps[k]]));
      new google.visualization.ColumnChart(document.getElementById('div_barras')).draw(google.visualization.arrayToDataTable(dataBarra), {title: 'Ocorrências por Aplicação'});
    }

    function prepararEnvio() {
      const form = {
        idLinha: document.getElementById('inputIdLinha').value,
        cd: document.getElementById('inputCd').value,
        qtd: parseInt(document.getElementById('inputQtd').value),
        aplic: document.getElementById('inputAplic').value,
        data: document.getElementById('inputData').value,
        parecer: document.getElementById('inputParecer').value
      };

      document.getElementById('loading').style.display = 'flex';
      apiCall('salvar', form).then(res => {
        alert(res.message);
        fecharModal();
        iniciarSistema();
      });
    }

    function abrirNovoRegistro() { 
      document.getElementById('formRegistro').reset();
      document.getElementById('inputIdLinha').value = "";
      document.getElementById('modalFormulario').style.display = 'flex'; 
    }
    function fecharModal() { document.getElementById('modalFormulario').style.display = 'none'; }
    function editarRegistro(id) {
       const item = dadosBrutos.find(d => d.idLinha == id);
       if(!item) return;
       document.getElementById('inputIdLinha').value = item.idLinha;
       document.getElementById('inputCd').value = item.cd;
       document.getElementById('inputQtd').value = item.qtd;
       document.getElementById('inputAplic').value = item.aplic;
       document.getElementById('inputData').value = item.dataInput;
       document.getElementById('inputParecer').value = item.parecer;
       document.getElementById('modalFormulario').style.display = 'flex';
    }
  </script>
</body>
</html>
